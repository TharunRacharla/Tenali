<!DOCTYPE html>
<html>
	<head>
		<title>AI Buddy</title>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	</head>
	<style>
		body {
			background-color: #121212;
			color: #ffffff;
			font-family: Arial, sans-serif;
			height: 100vh;
			display: flex;
			flex-direction: column;
			justify-content: flex-end;
			align-items: center;
			margin: 0;
			overflow: hidden; /* Prevent overflow from bubbles */
		}

		#chat-form {
			position: fixed;
			bottom: 10px;
			width: 90%;
			max-width: 600px;
			background: rgba(0, 0, 0, 0.8);
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			text-align: center;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 10px;
		}

		h1 {
			margin: 0;
		}

		#conversation {
			width: 100%;
			height: 200px; /* Fixed height for conversation display */
			overflow-y: auto; /* Allow scrolling if content overflows */
			background: #222;
			border-radius: 5px;
			padding: 10px;
		}

		.animation-state {
			display: none; /* Initially hidden */
			padding: 10px;
			background: rgba(255, 235, 59, 0.8);
			border-radius: 5px;
		}

		/* Show the animation when active */
		.active {
			display: block;
		}

		@media (max-width: 600px) {
			h1 {
				font-size: 24px;
			}

			#conversation {
				height: 150px; /* Smaller height on mobile */
			}

			.animation-state {
				font-size: 14px;
			}
		}

		#bubble-container {
			position: absolute;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			pointer-events: none;
		}
		.bubble {
			position: absolute;
			bottom: -50px;
			width: 20px;
			height: 20px;
			background-color: rgba(135, 206, 235, 0.6);
			border-radius: 50%;
			animation: bubble 15s linear infinite;
		}
		@keyframes bubble {
			0% {
				transform: translateY(0) scale(1);
			}
			50% {
				transform: translateY(-800px) scale(1.5);
			}
			100% {
				transform: translateY(0) scale(1);
			}
		}
	</style>
	<body>
		<div id="bubble-container"></div>
		<div id="chat-form">
			<h1 class="text-center">Welcome to AI Buddy</h1>

			<!-- Conversation Display Section -->
			<div id="conversation"></div>

			<!-- Listening and Recognizing Animations -->
			<div id="listening-animation" class="animation-state">Listening...</div>
			<div id="recognizing-animation" class="animation-state">
				Recognizing...
			</div>
		</div>

		<script>
			$(document).ready(function () {
				let greeted = false;
				let stopConversation = false; // Flag to stop conversation on "exit" response

				function startConversation() {
					if (stopConversation) return; // Stop further requests if conversation has ended

					// Run wishMe only once on initial load
					if (!greeted) {
						greeted = true;
						$.ajax({
							url: '/wish-me', // Adjust to the endpoint used for wishMe if necessary
							type: 'GET',
							success: function (data) {
								$('#conversation').append(
									`<p><strong>AI Buddy:</strong> ${data.greeting}</p>`
								);
							},
						});
					}

					// Show "Listening" animation
					$('#listening-animation').show();
					$('#recognizing-animation').hide();

					// Simulate listening state, then switch to recognizing state
					setTimeout(function () {
						$('#listening-animation').hide();
						$('#recognizing-animation').show();

						// AJAX request to handle the recognition and response
						$.ajax({
							url: '', // Replace with correct URL if needed
							type: 'POST',
							data: {
								csrfmiddlewaretoken: '{{ csrf_token }}',
							},
							success: function (data) {
								$('#recognizing-animation').hide();

								// Stop if "exit" command is received
								if (data.user_input === 'exit') {
									$('#conversation').append(
										`<p><strong>AI Buddy:</strong> ${data.response}</p>`
									);
									stopConversation = true; // Set flag to stop further processing
									return;
								}

								// Display conversation if not exiting
								const newResponse = `<p><strong>User:</strong> ${data.user_input}</p><p><strong>AI Buddy:</strong> ${data.response}</p>`;
								$('#conversation').append(newResponse);

								// Restart the conversation if not stopping
								startConversation();
							},
							error: function () {
								$('#recognizing-animation').hide();
								const errorMessage = `<p><strong>Error:</strong> There was an error processing your request.</p>`;
								$('#conversation').append(errorMessage);
							},
						});
					}, 2000); // Time delay to simulate recognizing state
				}

				// Start the conversation on page load
				startConversation();
			});

			// Bubble Animation
			const bubbleContainer = document.getElementById('bubble-container');
			function createBubbles() {
				for (let i = 0; i < 50; i++) {
					const bubble = document.createElement('div');
					bubble.classList.add('bubble');
					bubble.style.width = bubble.style.height = `${getRandomInt(
						10,
						60
					)}px`;
					bubble.style.left = `${getRandomInt(0, window.innerWidth)}px`;
					bubble.style.animationDuration = `${getRandomInt(10, 20)}s`;
					bubbleContainer.appendChild(bubble);
				}
			}
			function getRandomInt(min, max) {
				return Math.floor(Math.random() * (max - min)) + min;
			}
			createBubbles();
		</script>
	</body>
</html>
